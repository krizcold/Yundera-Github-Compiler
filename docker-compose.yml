name: yunderagithubcompiler

services:
  yunderagithubcompiler:
    image: krizcold/nginxhashlock:latest
    container_name: yunderagithubcompiler
    restart: unless-stopped
    expose:
      - "3000"
    user: "root"
    environment:
      AUTH_HASH: $AUTH_HASH
      BACKEND_HOST: "yunderagithubcompilerapp"
      BACKEND_PORT: "3000"
      LISTEN_PORT: "3000"
      ALLOWED_EXTENSIONS: "js,css,png,ico,svg,jpg,jpeg,gif,woff,woff2,ttf,eot"
      ALLOWED_PATHS: "api/app"
    depends_on:
      - yunderagithubcompilerapp
    networks:
      - pcs
    privileged: true
    cap_add:
      - SYS_ADMIN
      - NET_ADMIN

  yunderagithubcompilerapp:
    image: krizcold/yundera-github-compiler:latest
    container_name: yunderagithubcompilerapp
    restart: unless-stopped
    user: "root"
    entrypoint: ["/bin/sh"]
    command:
      - -c
      - |
        npm run setup
    environment:
      # Application settings
      WEBUI_PORT: "3000"
      
      # CasaOS integration
      DEPLOYMENT_MODE: "appstore"
      CASAOS_API_HOST: "localhost"
      CASAOS_API_PORT: "8080"
      DATA_ROOT: $DATA_ROOT
      
      # Yundera platform integration (unused - set to blank)
      DOMAIN: ""
      PROVIDER_STR: ""
      UID: ""
      DEFAULT_PWD: ""
      PUBLIC_IP: ""
      DEFAULT_USER: ""
      
      # Authentication and paths (unused - set to blank)
      JWT_SECRET: ""
      AUTHORITY_ENDPOINT: ""
      COMPOSE_FOLDER_PATH: ""
      BASE_PATH: ""
      MOCK: ""
      
      # Pass through the host's CasaOS environment variables.
      # These will be populated by the AppStore during installation.
      PUID: $PUID
      PGID: $PGID
      REF_DOMAIN: $REF_DOMAIN
      REF_NET: $REF_NET
      REF_PORT: $REF_PORT
      REF_SCHEME: $REF_SCHEME
      REF_SEPARATOR: $REF_SEPARATOR
      
      # Debug/logging settings (unused - set to blank)
      LOG_APPS_BEACON: ""      
      
      # Legacy variables (unused - set to blank)
      user: ""
      default_pwd: ""
      public_ip: ""

    volumes:        
      # cloned repos
      - type: bind
        source: /DATA/AppData/yunderagithubcompiler/repos
        target: /app/repos

      # persistent UI data storage
      - type: bind
        source: /DATA/AppData/yunderagithubcompiler/uidata
        target: /app/uidata

      # Writable mount for app metadata
      - type: bind
        source: /DATA/AppData
        target: /DATA/AppData

      # Bind mount for the main app directory
      - type: bind
        source: /DATA/AppData/casaos/apps/yunderagithubcompiler
        target: /DATA/AppData/casaos/apps/yunderagithubcompiler
        read_only: true

      - type: bind
        source: /var/run/docker.sock
        target: /var/run/docker.sock

    # Connect to the same network as the CasaOS service
    networks:
      - pcs
    
    # Add privileges to access CasaOS data (similar to CasaOS container)
    privileged: true
    
    # Add capabilities
    cap_add:
      - SYS_ADMIN
      - NET_ADMIN
    
    # Resource limits
    cpu_shares: 50
    deploy:
      resources:
        limits:
          memory: 512M

    x-casaos:
      volumes:
        - container: /app/repos
          description:
            en_us: "Git repos are cloned here."
        - container: /app/uidata
          description:
            en_us: "Persistent UI data storage."

# Define the network as external, since it's created by the main NSL stack
networks:
  pcs:
    external: true

x-casaos:
  architectures:
    - amd64
    - arm64
  main: yunderagithubcompiler
  author: krizcold
  developer: krizcold
  icon: https://github.com/krizcold/Yundera-Github-Compiler/blob/main/YunderaCompiler.png?raw=true
  tagline:
    en_us: "Automatically build and deploy GitHub repos on Yundera"
  category: Utilities
  description:
    en_us: "Clone, build, and run Docker-based projects directly from GitHub URLs."
  title:
    en_us: "Yundera GitHub Compiler"
  store_app_id: yunderagithubcompiler
  is_uncontrolled: false
  index: /?hash=$AUTH_HASH
  webui_port: 3000
  pre-install-cmd: |
    mkdir -p /DATA/AppData/yunderagithubcompiler/{repos,uidata} 2>/dev/null
    chown -R ubuntu:988 /DATA/AppData/yunderagithubcompiler/ 2>/dev/null || true
    chmod -R 755 /DATA/AppData/yunderagithubcompiler/ 2>/dev/null || true
